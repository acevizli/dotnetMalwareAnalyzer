from django.http.response import HttpResponse
from django.shortcuts import render
import os
import re
import subprocess
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework import status
import json
from .models import ClassCode

# Create your views here.
"""
@api_view(["POST"])
def Analyzer(request):
    data = json.loads(request.body.decode("utf-8"))
    folder = data["folder"]
    dotnets = []
    files = [f for f in os.listdir(folder) if f.endswith(".exe")]
    print("------------------------------------------------------------------")
    for file in files:
        stream = os.popen(".\\Scripts\\diec.exe -d {}".format(folder + "\\" + file))
        output = stream.readlines()
        for o in output:
            print(o, end="")
            if "library: .NET" in o:
                dotnets.append(file)
        os.popen(".\\Scripts\\diec.exe -e {}".format(folder + "\\" + file))
        print("------------------------------------------------------------------\n")
    for dotnet in dotnets:
        malware = Malware.objects.create(name=dotnet)
        stream = os.popen(".\\Scripts\\diec.exe -e {}".format(folder + "\\" + file))
        output = stream.readlines()
        print(dotnet)
        for line in output[1:]:
            print(line)
            entropy = line.split("|")
            EntropySection.objects.create(
                malware=malware,
                name=entropy[1],
                offset=entropy[2],
                size=entropy[3],
                entropy=float(entropy[4].split(" ")[0][:-1]),
                status=entropy[4].split(" ")[1],
            )
        proc = subprocess.Popen(
            ["powershell", ".\Scripts\Demo.ps1 {}".format(folder + "\\" + dotnet)],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
        )
        lines = proc.stdout.read().decode("utf-8")
        classes = re.split("@class@", lines)
        for c in classes:
            ClassCode.objects.create(malware=malware, code=c)
    return Response(status=status.HTTP_200_OK)
"""

import shutil

import random
from wsgiref.util import FileWrapper

csprojTemplate = '<Project Sdk="Microsoft.NET.Sdk">\n\t<PropertyGroup>\n\t<OutputType>Exe</OutputType>\n\t\t<TargetFramework>net5.0</TargetFramework>\n\t</PropertyGroup>\n</Project>'
from django.http import FileResponse


@api_view(["POST"])
def GenerateDotnet(request):
    sources = []
    data = request.data
    print(data)
    for module in data["modules"]:
        source = ClassCode.objects.filter(type=module["type"])
        sources.append(source[random.randint(0, len(source) - 1)])
    path = ".\\Scripts\\DotnetProject"
    i = 1
    for fname in os.listdir(path):
        if fname.startswith("source"):
            os.remove(os.path.join(path, fname))
    f = open(os.path.join(path, "DotnetProject.csproj"), "w")
    f.write(csprojTemplate)
    f.close()
    for source in sources:
        f2 = open(os.path.join(path, "source{}.cs".format(i)), "w")
        f2.write(source.code)
        f2.close()
        i += 1
        for package in source.packageDependincies.all():
            proc = subprocess.Popen(
                "dotnet add package {}".format(package.package),
                shell=True,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                cwd=path,
            )
            proc.communicate()

    command = "dotnet build"
    proc = subprocess.Popen(
        command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, cwd=path
    )
    proc.communicate()
    malware_path = os.path.join(path, "bin\\Debug\\net5.0")
    shutil.make_archive("malware", "zip", malware_path)
    zip_file = open("malware.zip", "rb")
    response = FileResponse(zip_file)
    return response
