import os
import sys
import subprocess

from .models import Malware,EntropySection,ClassCode

folder = sys.argv[1]

dotnets = []
files = [f for f in os.listdir(folder) if f.endswith('.exe')]
print("------------------------------------------------------------------")
for file in files:
    stream = os.popen(".\Scripts\diec.exe -d {}".format(folder +"\\"+ file))
    output = stream.readlines()
    for o in output:
        print(o, end = '')
        if "library: .NET" in o:
            dotnets.append(file)
    os.popen("./Scripts/diec.exe -e {}".format(folder +"\\"+ file))
    print("------------------------------------------------------------------\n")
import re
for dotnet in dotnets:
    malware = Malware.objects.create(name = dotnet)
    stream = os.popen(".\Scripts\diec.exe -d {}".format(folder +"\\"+ file))
    output = stream.readlines()
    for line in output:
        entropy = line.split('|')
        EntropySection.objects.create(
            malware = malware,
            name = entropy[1],
            offset = entropy[2],
            size = entropy[3],
            entropy = float(entropy[4].split(' ')[0][:-1]),
            status = entropy[4].split(' ')[1],
            )
    proc = subprocess.Popen(["powershell",".\Scripts\Demo.ps1 {}".format(folder + "\\"+dotnet)],stdout=subprocess.PIPE,stderr=subprocess.PIPE)
    lines = proc.stdout.read().decode('utf-8')
    classes = re.split('@class@',lines)
    for c in classes:
        ClassCode.objects.create(
            malware = malware,
            code = c
        )

